# 記事更新通知
WordPressに投稿された記事の更新通知をLINEユーザーに送信する方法です。

## LINE投稿手順
### 通知する投稿タイプの選択
1. 投稿通知タブの投稿タイプより、通知したい投稿タイプを選択して設定しておきます。カスタム投稿タイプにも対応しています。

### 投稿時（投稿画面での操作）
1. 投稿画面で、右カラムに「LINE Connect」ボックスが表示されるので、通知したい場合は「更新通知を送信する」へチェックを入れます。  
   ※チェックが入っていると新規投稿だけでなく更新する場合でも通知が行われます。  
   ※「予約投稿時に送信する」にチェックを入れて保存すると、予約投稿が公開された時にLINE通知が行われます。  
2. 画像付きで通知させたい場合は、アイキャッチ画像を設定してください。
3. 「送信対象」リストからLINEで通知するユーザーを選択します。
   - 各チャネル（従来のチャネル）は従来どおり「すべての友達」「連携済みの友達」、および連携済みの友達のうち各ロールに属するユーザーを選択できます。（複数選択可能）
   - チャネル一覧の最後に「オーディエンス」が表示されます。オーディエンスを選択した場合は、WordPress のカスタム投稿タイプ「Audience」に保存されている投稿一覧が選択肢として表示されます。複数のオーディエンスにチェックを入れると、それぞれのオーディエンスに対して個別に送信されます（重複しているユーザーには重複して送信されます）。
4. 「メッセージテンプレート」リストから、使用するテンプレートを選択してください。デフォルトテンプレートの場合は設定画面で大まかなデザインや色を調整できます。その他のテンプレート（LCメッセージ）の場合は、自分でメッセージを組み立てることで細かなところまでカスタマイズを行えます。

### メッセージテンプレートとしてLCメッセージを使う場合に使用できる変数
|変数名|内容|
|----:|----|
|`{{formatted_title}}`|投稿タイトル|
|`{{formatted_content}}`|タグや改行などを取り除いた本文先頭500文字|
|`{{post_thumbnail}}`|アイキャッチ画像URL|
|`{{post_permalink}}`|投稿パーマリンク|
|`{{link_label}}`|「もっと読む」ラベル|
|`{{alttext}}`|タイトル、本文、リンクを結合した先頭400文字|

#### WP_Postオブジェクトのプロパティ
[WP_Post](https://developer.wordpress.org/reference/classes/wp_post/) オブジェクトの各プロパティもテンプレート内で変数として使用できます。例)
|変数名|内容|
|----:|----|
|`{{post_date}}`|投稿日時|
|`{{post_excerpt}}`|投稿の抜粋|
|`{{post_category.0}}`|1つ目のカテゴリーID|
|`{{post_category.1}}`|2つ目のカテゴリーID|
|`{{tags_input.0}}`|1つ目のタグ|

#### カスタムフィールド（post_meta）の値
投稿のカスタムフィールドの値は `{{post_meta.カスタムフィールド名}}` の形式で利用できます。配列・オブジェクト構造のメタデータでも、ドット区切りで階層パスを指定してテンプレート内で参照可能です（例: `{{post_meta.some_key.sub_key}}`）。

---

### REST APIからのチャネル・ロール・オーディエンス指定方法
REST APIから記事投稿（または更新）を行う際に、LINE通知を指定するための JSON 例を示します。

- チャネル（従来の指定方法）
```
"lc_channels": {
  "(通知させたいチャネルのシークレットの先頭4文字)": {
    "roles": ["ロール名1", "ロール名2"],
    "template": LCメッセージの投稿ID（デフォルトテンプレートの場合は0）
  }
}
```

- オーディエンス指定（新しい指定方法）
  - `audience` をキーにして、`roles` に Audience 投稿ID の配列を渡します。
```
"lc_channels": {
  "audience": {
    "roles": [123, 456],       // Audience 投稿ID の配列
    "template": LCメッセージの投稿ID（デフォルトテンプレートの場合は0）
  }
}
```
上記では Audience 投稿ID 123 と 456 に対応するオーディエンスにメッセージがそれぞれ送信されます。複数指定したオーディエンスに同じ投稿が送られ、オーディエンスが重複するユーザーには重複送信される点に留意してください。

#### 互換性のための旧フォーマット（バージョン3.2.1以前）
従来の古いフォーマット（文字列でロールをカンマ区切り）はまだサポートされています。
```
"lc_channels": {
  "(通知させたいチャネルのシークレットの先頭4文字)": "ロール名（複数ある場合は「,」で区切る）"
}
```

---

## スクリーンショット
友達登録しているユーザーへはこのようにLINEのメッセージが表示されます。  
<img src="https://blog.shipweb.jp/wp-content/uploads/2021/03/PNG-imageposttoline.png" width="320"></img>  
リンクテキストや背景色、サムネのアスペクト比をカスタマイズすることも可能です。  
<img src="https://blog.shipweb.jp/wp-content/uploads/2021/03/PNG-imageposttolinecustom.png" width="320"></img>  

---

注意:
- オーディエンスを使った送信は、管理画面の「Audience（オーディエンス）」として保存済みのカスタム投稿を参照して送信対象を決定します。Audience の管理や作成はドキュメントの [オーディエンス](./audience.md) セクションを参照してください。
- テンプレートの変数挙動は、カスタムメタデータや WP_Post のプロパティがテンプレート内で正常に展開されるよう修正されています。
