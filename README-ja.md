# LINE Connect 
LINE ConnectはLINE公式アカウントをWordPressで活用するのに役立つ機能を備えたWordPressプラグインです。  
WordPressユーザーと、LINEユーザーの連携、記事投稿通知、リッチメニュータップやメッセージ受信をトリガーとしてメッセージ送信などの各種アクションを実行できます。  

## 特徴・使い方
[LINE Connect ドキュメント](https://lc.shipweb.jp/)をご覧ください。

## イベントログ
受診したWebhookイベントログを表示します。イベントタイプや送信したユーザー、メッセージの内容などを確認できます。
## 一括配信
記事の投稿時に記事内容をLINEで送信するのではなく、任意のテキストをLINEメッセージで送信することができます。
### すべての友達、連携済みの友達、ロール指定して送信
LINE Connectメニューより「一括配信」ページを開きます。  
<img src="https://blog.shipweb.jp/wp-content/uploads/2022/01/lineconnect-ss-10.jpg" width="320">  
#### チャネル  
送信する対象のチャネル（LINE公式アカウント）を選択します。  
#### 送信先タイプ  
どのユーザーグループに送信するかを指定します。  
- 全て：友達登録しているユーザー全員に、連携済みかどうかにかかわらず送信します。
- 連携済み：友達登録しているユーザーのうち、Wordpressと連携しているユーザーに送信します。
- ロール指定：連携済みのユーザーのうち、特定のロールに属するユーザーに送信します。
- ユーザー指定：送信するユーザーを一人ずつ個別に指定して送信します。（指定方法は後述）

#### ロール
送信先タイプをロール指定にした場合、どのロールに属するユーザーに送信するかを選択します。  
#### メッセージ  
送信するLINEメッセージ内容を入力します。  

### ユーザーを個別に指定して送信
一括配信ページからは送信するユーザーを個別に指定できないため、ユーザー一覧ページから対象ユーザーを指定してください。
#### 一人だけ選択する場合
LINE連携カラムの「☑」リンクから一括配信ページへ移動すると、そのユーザーが指定された状態になります。  
<img src="https://blog.shipweb.jp/wp-content/uploads/2023/08/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-2023-08-08-23.02.40.png" width="320">  
#### 複数ユーザーの選択
対象ユーザーのチェックボックスにチェックを入れ、一括操作で「LINE送信する」を選択し「適用」ボタンをクリックします。  
<img src="https://blog.shipweb.jp/wp-content/uploads/2022/01/lineconnect-ss-12.jpg" width="320">  
チェックしたユーザーが指定された状態で一括配信画面が開きます。  
<img src="https://blog.shipweb.jp/wp-content/uploads/2022/01/lineconnect-ss-13.jpg" width="320">  

## ダイレクトメッセージ
公式アカウントを友だちに追加しているか、7日以内にLINE公式アカウントへメッセージを送ったユーザーなど、イベントログにLINEユーザーIDが記録されている場合、そのLINEユーザーへLINEテキストメッセージを送信できます。  
イベントログのユーザーIDカラムにマウスオーバーで表示される「メッセージ」リンクをクリックすることで、送信先ユーザーを指定できます。

## トリガー

### トリガータイプ

#### Webhook
条件に一致するwebhookイベントをトリガーとしてアクションを実行します。
##### イベントタイプ
メッセージ/ポストバック/アカウント連携/友だち追加(フォロー)/ブロック(フォロー解除)などWebhookイベントの種類です。  
イベントタイプについて詳しくは<a href='https://developers.line.biz/ja/docs/messaging-api/receiving-messages/#webhook-event-types'>メッセージ（Webhook）を受信する | LINE Developers</a>をご覧ください。  
##### キーワード
イベントタイプが「メッセージ」で、メッセージタイプが「テキスト」の場合やイベントタイプが「ポストバック」の場合、受け取ったデータの条件を指定します。  
テキストメッセージを受診した場合、データは受け取ったメッセージ、ポストバックの場合は、dataプロパティの内容がデータとなります。
###### ソース
- キーワード: データを文字列として扱います
- クエリストリング: データをクエリ文字列として扱います
###### マッチタイプ
ソースが「キーワード」の場合、キーワードを含む/等しい/で始まる/で終わる/正規表現のいずれかからマッチングの方法を選択します。
ソースが「クエリストリング」の場合、指定したパラメーターがデータのクエリストリングをパースしたときのデータに含まれるか(それ以外のデータが含まれていても一致とみなす)、それとも等しいか(それ以外のデータが含まれている場合は一致とみなさない)を選択します。

##### ソース条件
受信したイベントのソース情報に基づいてトリガーを発動するかどうかを決定するための条件設定です。
###### チャネル
Webhookイベントを受信したチャンネルを指定します。
###### ソース
ソースには「ユーザー」「グループ」「ルーム」を指定します。
###### ユーザー
Webhookイベントを発行元(送信者)のユーザーの属性でトリガーを発動するかどうか条件設定を行います。
- 連携状態: Wordpressユーザーとの連携状態を条件として「いずれでも」「連携済み」「未連携」の中から選択します。
- ロール: ユーザーのロールを条件に指定します。
- LINEユーザーID: 特定のLINEユーザーIDを条件に指定します。
###### グループ
Webhookイベントの発行元としてLINEグループを条件として設定します。
- LINEグループID: 発行元のLINEグループIDを条件に指定します。
###### ルーム
複数人トークをWebhookイベントのソース条件として設定します。
- LINEグループID: 複数人トークルームのIDを条件として設定します。
###### キーワード/ソース条件グループ
条件をグループ化します。グループ内のソース条件がすべて一致する場合(AND)やいずれかが一致する場合(OR)に全体を一致とみなすように複数の条件を設定できます。
###### 論理否定
「否定」のチェックを入れると、条件の判定が反転します。具体的には、次のように動作します：
- 条件に一致する場合は、一致しないとみなされます。
- 条件に一致しない場合は、一致するとみなされます。
###### 演算子
複数の条件がある場合に、それらの条件をどのように扱うかを指定します。
- And: すべての条件が一致する場合にのみ、全体として一致するとみなされます。
- Or: 条件のうち少なくとも1つが一致する場合に、全体として一致するとみなされます。
#### スケジュール
指定した日付や時刻、曜日などをトリガーとしてアクションを実行します。
##### 一度
一回限りのスケジュールを設定します。
- 日付時刻: トリガーを発動する日付時刻を指定します。
##### 繰り返し
###### 毎時
指定した時刻にトリガーが発動します。
###### 毎曜日
指定した曜日にトリガーが発動します。
- 計算方法: 曜日の計算方法です。月の第何曜日として計算するか、第何周目の何曜日として計算するかの指定です。
- 第何曜日/第何周目: 「計算方法」の選択により意味が異なります。
  - 「第何曜日」を選択していた場合、1を選んだ場合は第1◯曜日を指します。
  - 「月の第何周目」を選択していた場合、1を選んだ場合は、月の第1周目の◯曜日を指します。
- 曜日: 日曜日から土曜日までの曜日指定です。
- 週の最初の曜日:  「月の第何周目」を選択した場合に、週の最初を日曜日とするか、月曜日とするかを設定します。
###### 毎日
指定した日付にトリガーが発動します。月の最終日にチェックをいれると、その月の最終日にトリガーが発動します。
###### 毎週
指定した週番号の週にトリガーが発動します。
###### 毎月
指定した月にトリガーが発動します。
###### 毎年
指定した年にトリガーが発動します。
###### 開始日
現在時刻が開始日を過ぎていない場合はトリガーは発動しません。
また、開始日と時刻は各種指定したスケジュールでは定まらない日付時刻の基準となります。
例)開始日が「2024/05/15 21:38」の場合
- 毎時で0時にチェックを入れていたら、毎日0:38にトリガーが実行されます。
- 毎曜日で第1火曜日にチェックを入れていたら、第1火曜日の21:38にトリガーが実行されます。
- 毎日で1日にチェックを入れていたら、毎月1日の21:38にトリガーが実行されます。
- 毎週で週番号に2を指定していたら、その年の第2週目の開始日の曜日(2024/5/15は水曜日)21:38にトリガーが実行されます。
- 毎月で8月にチェックを入れていたら、その年の8/15 21:38にトリガーが実行されます。
###### 終了日
現在時刻が終了日を超えている場合、トリガーは発動しません・
###### 事前通知
- 事前通知する分数
入力すると、対象となる時刻よりも指定した分だけ事前にトリガーが発動します。  
例えば、毎月最終日の24時間前にトリガーを発動させたい場合、月の最終日にチェックをいれた上で、事前通知する分数に「1440」を入力します。こうすることで最終日は不定でも、その1日前にトリガーを発動できます。

#### アクション
トリガーが発動した場合に実行するアクションです。
以下の種類のアクションが用意されています。フィルターフックを利用して独自のアクションを追加することも可能です。
- 情報を取得して返すアクション
- 情報を検索して返すアクション
- メッセージ送信などの動作を行うアクション

アクションはAI応答のFunction Calling機能で使用するFunctionと共用です。
##### アクションの戻り値
###### 戻り値をLINEメッセージで送信
チェックをいれると、アクションの戻り値が、Webhookイベントの送信元に応答メッセージとして送信されます。  

戻り値の型によって、送信されるメッセージが異なります。
- 文字列: LINEテキストメッセージとして送信
- LINE\LINEBot\MessageBuilderのインスタンス: LINEメッセージオブジェクトとして送信
- その他: ダンプしたものをLINEテキストメッセージとして送信

応答メッセージとして送信されるのは、トリガータイプがWebhookイベントの場合のみです。
トリガータイプがスケジュールの場合はチェックを入れても戻り値はLINEメッセージとしては送信されません。
その場合、アクションチェイン機能を用いて「LINEメッセージ送信」アクションの引数にセットすることで、希望のユーザーへLINEメッセージを送信できます。


##### 変数の埋め込み
アクションの引数が文字列の場合、各変数を埋め込んで使用することができます。

###### アクションの戻り値
順次実行されていくアクションの戻り値を、それ以降のアクションの引数内のプレースホルダーで使用することができます。
`{{$.return.アクション番号}}`
アクション番号は、1から始まるアクションの順番です。
対象アクションの戻り値が配列の場合、アクション番号に続けて「.キー」を追加することで、特定の値だけを取り出せます。
例) アクション-1(アクション番号1)に「現在日時取得」アクションを設定します。
アクション-2(アクション番号2)に「LINEテキストメッセージ取得」を設定します。
アクション-2のparametersのbodyに「現在時刻は{{$.return.1.datetime}}です。」と入力します。
これにより、現在時刻がメッセージ内に埋め込まれて送信されます。

###### Webhookイベントデータ 
受信したWebhookイベントに含まれるデータを使用できます。
`{{$.webhook.イベントオブジェクトのプロパティ}}`
例)公式アカウントに送信されたテキストメッセージを使用する場合
`{{$.webhook.message.text}}`

###### ユーザーデータ
Webhookイベント送信元ユーザーのデータを使用できます。
`{{$.user.WPUserオブジェクトのプロパティ}}`
例）ユーザーの表示名を使用する場合
 WordPressユーザーと連携済みの場合は、WordPressユーザーの表示名が、未連携の場合はLINEユーザーの表示名が取得できます。
`{{$.user.data.display_name}}`
LINEユーザーのプロフィール（プロフィール画像URLなど）は`{{$.user.profile.プロフィールプロパティ}}`で使用できます。
プロフィールプロパティとして使える値は`displayName`、`pictureUrl`、`language`、`statusMessage`です。

##### アクションチェイン
アクションの引数がオブジェクトやあらかじめ決められた定数から選択する形式の場合は変数の埋め込みが行えません。
その場合、チェインルールを追加することで、任意のアクションの戻り値をそれ以降のアクションの引数に注入することができます。

###### 注入先引数
注入先引数の指定方法: `アクション番号.引数名`
- アクション番号: 1から始まるアクションの順番
- 引数名: それぞれのアクションで必要とする引数に対応する名前
例）アクション-2のmessageを注入先引数として指定する場合: `2.message`
({{ }}で囲む必要がないことに注意してください）

###### データ
注入するデータには文字列を使用したり、変数の埋め込みが可能です。

## LCメッセージ(メッセージテンプレート)
各種LINEメッセージをあらかじめテンプレートとして作成しておき、LINEメッセージ取得や送信アクション実行時に使用することができます。
一回の送信で最大5つのメッセージを送信できます。
### メッセージタイプ
メッセージタイプについては<a href='https://developers.line.biz/ja/docs/messaging-api/message-types/'>メッセージタイプ | LINE Developers</a>を参照してください。

作成したメッセージは「LINE Connectメッセージ取得」アクションで呼び出して使用することができます。
アクションで「LINE Connectメッセージ取得」を選択し、パラメーターのslc_message_idから使用したいメッセージを選択します。

`{{キー}}`をメッセージ文中に埋め込むことで、アクション実行時に、名前などキーに対応する値を差し込むことができます。

例えば、「{{name}}さん友だち追加ありがとうございます！」という内容でテキストメッセージを作成し保存しておきます。
トリガーでイベントタイプをフォローに設定し、アクションで「LINE Connectメッセージ取得」を選択し、parametersのslc_message_idでは作成しておいたメッセージを選択します。
args（メッセージ置換用引数）を追加し、キーに`name`、値(name)に`{{$.user.data.display_name}}`を設定します。
これにより、メッセージ文中の`{{name}}が`ユーザーの表示名で置き換えられて送信されます。

## 開発者向け他プラグインとの連携方法
他プラグインからLINEメッセージ送信を呼び出せるよういくつかアクションフックが用意されています。
### アクションフック
#### send_message_to_wpuser($channel, $wp_user_id, $message)
連携済みのWordpressユーザーにLINEメッセージを送信します。
##### 使い方
```
//デフォルト（登録されているチャネルが1つならそのチャネル、複数登録されている場合は最初のチャネル）のユーザーIDが2のユーザーへメッセージ送信
do_action('send_message_to_wpuser', null, 2, 'Wordpressからのメッセージ');

//チャンネルシークレットの先頭4文字でチャネルを指定してチャネル情報を取得
do_action('send_message_to_wpuser', lineconnect::get_channel('1fa8'), 3, 'Wordpressからのメッセージ');

//送信するチャネルのアクセストークンとシークレットを連想配列で渡す場合
$channel = array(
    'channel-access-token' => '実際のチャネルアクセストークン',
    'channel-secret' => '実際のチャネルシークレット'
);
do_action('send_message_to_wpuser', $channel, 3, 'Wordpressからのメッセージ');

//LINE BOT SDKを利用してImageMessageBuilderを作成し、画像を送信
require_once(plugin_dir_path(__FILE__).'../lineconnect/vendor/autoload.php');
$originalContentUrl = "https://example.com/img.jpg";
$previewImageUrl = "https://example.com/img.jpg";
$imageMessageBuilder = new \LINE\LINEBot\MessageBuilder\ImageMessageBuilder($originalContentUrl, $previewImageUrl);
do_action('send_message_to_wpuser', null, 3, $imageMessageBuilder);
```
##### パラメータ
**$channel (array|null)**  
channel-access-token、channel-secretを持つチャネル情報の連想配列か、null（デフォルトチャネルを使用）  
※デフォルトチャネルは、登録されているチャネルが1つならそのチャネル、複数登録されている場合は最初のチャネルです。  
**$wp_user_id (int)**   
 メッセージを送信するユーザーのWordpress ID（LINEユーザーIDではないことに注意）  
**$message (string|LINE\LINEBot\MessageBuilder)**  
送信するメッセージ。文字列の場合はテキストメッセージを作成して送信します。LINE BOT SDKを利用してMessageBuilderで作成したメッセージを送ることもできます。

#### send_message_to_role($channel, $role, $message)
ロールを指定して連携済みユーザーへLINEメッセージを送信します。``$role``に予約されている値を渡すことで、連携済みユーザー全てに送信することもできます。
##### 使い方
```
//管理者ロールのユーザーへメッセージを送信
do_action('send_message_to_role', null, array("administrator"), 'Wordpressからのメッセージ');

//すべての連携済みユーザーへメッセージを送信
do_action('send_message_to_role', null, array("slc_linked"), 'Wordpressからのメッセージ');

```
##### パラメータ
**$channel, $message**  
send_message_to_wpuserのパラメータと同じです。  
**$role (array)**   
送信対象とするロールスラッグの配列。例）administrator  
``slc_linked``を指定すると、すべての連携済みユーザーへ送信します。  

**チャネル指定時の注意**  
デフォルトチャネルは、チャネルの削除によって変化します。例えば複数チャネルがある場合、1番目のチャネルを削除すると、２番目のチャネルがデフォルトチャネルになります。確実を期すためにはチャネル情報を配列で指定するか、チャネル情報をシークレットの先頭4文字で取得したものを使用してください。
```
$channel = lineconnect::get_channel("(シークレットの先頭4文字)");
```

### LINEユーザーIDの保存形式
連携済みユーザーのLINEユーザーID、表示名、プロフィール画像URLはユーザーメタに``line``というキー名で保存されています。
#### メタデータの形式  
```
//ユーザーID:3のLINEユーザーIDを取得
$user_meta_line = get_user_meta(3, 'line', true);
var_dump($user_meta_line);

array(1) {
  ["(シークレットの先頭4文字)"]=>
  array(3) {
    ["id"]=>
    string(33) "(LINEユーザーID)"
    ["displayName"]=>
    string(12) "(表示名)"
    ["pictureUrl"]=>
    string(135) "(プロフィール画像URL)"
  }
}
```
複数チャネルに対応しているため、チャネルシークレットの先頭4文字をキーとする連想配列がトップレベルにあり、その中に``id``,``displayName``,``pictureUrl``をキーとする連想配列が含まれます。

### REST APIからのチャネル・ロール指定方法
REST APIから記事投稿する際にLINE ConnectにてLINE通知させたい場合は以下のキー＆値をJSONデータに加えてください。
```
  "lc_channels":{
      "(通知させたいチャネルのシークレットの先頭4文字)":"ロール名（複数ある場合は「,」で区切る）"
  }
```

### LINE通知ログの保存
STREAMプラグインがインストールされ有効な場合、LINE通知の種類（マルチキャスト、プッシュメッセージ、ブロードキャスト）、何通送信したかのログがStream Recordsに記録され後から閲覧できます。

### WP LINE Loginとの連携機能
下記の条件を満たす場合、LINE Connectでユーザー連携を行った際に、[WP LINE Login](https://blog.shipweb.jp/wplinelogin/)においても、該当ユーザーをLINEログイン連携状態にさせることが可能です。  
* WP LINE Loginがインストールされている
* LINE Loginの設定で「Messaging APIチャネルシークレット」が、LINE Coonectの「チャネルシークレット」と一致している

連携解除した場合、LINEログイン連携状態も解除されます。

## カスタマイズ・プラグイン作成
その他さまざまなカスタマイズを有償で承ります。[連絡先はこちら](https://blog.shipweb.jp/contact)

# 必要動作環境
* Wordpress  5.0以上

# 制作者
* ship [blog](https://blog.shipweb.jp/)

# 謝辞
* 素晴らしいプラグイン「LINE AUTO POST」を開発してくださったGrowniche社の方々

# ライセンス
GPLv3