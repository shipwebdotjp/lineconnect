---
id: interaction
title: インタラクション
---

インタラクションは、LINE公式アカウントのユーザーと対話形式でコミュニケーションをとるための機能です。アンケートの実施、予約の受付、ユーザープロセスのガイドなど、さまざまな目的に利用できます。

## インタラクションの作成

新しいインタラクションを作成するには、WordPressダッシュボードの「インタラクション」メニューに移動し、「新規追加」をクリックします。インタラクションの動作とフローを定義するためのフォームが表示されます。

## インタラクション設定

インタラクションフォームのトップレベルで、インタラクションの全体的な設定を行うことができます。

| フィールド | 説明 |
| :--- | :--- |
| **タイムアウト (分)** | 非アクティブな状態が何分続いたらインタラクションセッションを期限切れにするかを設定します。0に設定するとタイムアウトしません。 |
| **タイムアウトリマインダーを送信** | タイムアウトの何分前にリマインダーメッセージを送信するかを設定します。0に設定するとリマインダーは送信されません。リマインダーメッセージの内容は、特別な「タイムアウトリマインド」ステップで定義します。 |
| **タイムアウト時** | セッションがタイムアウトしたときの動作を定義します。<br/> - **セッションを削除**: セッションデータが完全に削除されます。<br/> - **タイムアウトとしてマーク**: セッションはタイムアウトとしてマークされますが、データは保持されます。 |
| **実行ポリシー** | 同じユーザーに対して複数のインタラクションセッションが同時に発生した場合の処理方法を定義します。<br/> - **許可しない**: ユーザーがすでにアクティブなインタラクションを持っている場合、新しいインタラクションの開始を許可しません。<br/> - **許可 (最新のみ保持)**: 新しいインタラクションの開始を許可し、前のインタラクションは終了させます。<br/> - **許可 (履歴を保持)**: 複数のインタラクションを同時に実行することを許可します。 |
| **上書きポリシー** | 別のインタラクションがすでに進行中に新しいインタラクションリクエストがあった場合の処理方法を定義します。<br/> - **拒否**: 新しいインタラクションリクエストは拒否されます。<br/> - **同じもののみ再起動**: 新しいインタラクションが現在のものと同じ場合、現在のものを再起動します。<br/> - **異なるもののみ再起動**: 新しいインタラクションが現在のものと異なる場合、現在のものを終了して新しいものを開始します。<br/> - **常に再起動**: 新しいインタラクションリクエストは現在のものを終了し、新しいものを開始します。<br/> - **スタック**: 現在のインタラクションを一時停止し、新しいものを開始します。新しいインタラクションが完了すると、前の一時停止したインタラクションを再開します。 |
| **バージョン** | インタラクションフォームのバージョンです。使用中の既存のインタラクションに構造的な変更を加える場合は、このバージョン番号をインクリメントしてください。 |
| **ストレージ** | 収集したデータの保存場所を定義します。<br/> - **プロフィールにバインド**: データはユーザーのプロフィールメタに保存されます。<br/> - **インタラクション**: データはインタラクションセッションデータ内に保存されます。 |
| **除外ステップ** | データストレージから除外するステップIDのリストです。確認画面など、ユーザーデータを収集しないステップに便利です。 |
| **キャンセルワード** | ユーザーから受信したときにインタラクションを即座に終了させる単語やフレーズのリストです。一致条件（完全一致、部分一致、正規表現）を定義できます。 |

## ステップの構築

インタラクションは1つ以上のステップで構成されます。各ステップが会話の一部を定義します。

### ステップの設定

| フィールド | 説明 |
| :--- | :--- |
| **ID** | ステップの一意の識別子です。分岐やデータ参照に使用されます。英数字とハイフン（例: `ask-name`, `confirm-email`）を使用することをお勧めします。 |
| **タイトル** | 管理エディタで表示されるステップのタイトルです。 |
| **説明** | 管理エディタで表示されるステップの説明です。 |
| **次のステップID** | 他の分岐ロジックが適用されない場合に、このステップが完了した後に進むステップのIDです。 |
| **停止** | 有効にすると、このステップの後にインタラクションが終了します。 |

### メッセージの送信

各ステップで、ユーザーに1つ以上のメッセージを送信できます。さまざまなメッセージタイプから選択できます。

- **テキスト**: シンプルなテキストメッセージ。
- **スタンプ**: LINEスタンプ。
- **画像, 動画, 音声**: メディアメッセージ。
- **位置情報**: 地図上の位置情報ピン。
- **Flex**: [Flex Message Simulator](https://developers.line.biz/flex-simulator/)で作成したJSONを使用してカスタマイズ可能なレイアウトのメッセージ。
- **Raw**: LINEメッセージの生のJSONオブジェクト。
- **テンプレートボタン**: タイトルとボタンのセットを持つメッセージ。各ボタンにはラベル、値、および会話を分岐させるための`nextStepId`を設定できます。
- **確認テンプレート**: 確認フローのための「適用」と「編集」ボタンを持つ定義済みのテンプレート。
- **編集ピッカーテンプレート**: ユーザーが編集したい前のステップを選択できるテンプレート。
- **キャンセル確認テンプレート**: ユーザーにインタラクションをキャンセルするかどうかを確認するための定義済みのテンプレート。

### ユーザー入力の処理

各ステップでユーザーの入力を処理し、検証することができます。

#### 正規化

正規化ルールは、検証と保存の前にユーザーの入力をクリーンアップします。

- **トリム**: 入力の最初と最後の空白を削除します。
- **省略...**: コンマ、ハイフン、スペースなどの文字を削除します。
- **文字変換**: 日本語の文字セット（ひらがな、カタカナ）間、または半角と全角の英数字間で変換します。

#### 検証

検証ルールは、ユーザーの入力が正しい形式であることを保証します。検証に失敗した場合、ユーザーに再度プロンプトが表示されます。

- **必須**: ユーザーは入力を提供する必要があります。
- **数値**: 入力は数値でなければなりません（オプションで最小/最大値を設定可能）。
- **長さ**: 入力は特定の文字数でなければなりません（オプションで最小/最大長を設定可能）。
- **Eメール, 電話番号, URL**: 入力は有効なEメール、電話番号、またはURLでなければなりません。
- **日付, 時刻, 日時**: 入力は日付/時刻形式に一致する必要があります。
- **Enum**: 入力は定義済みの値のリストのいずれかでなければなりません。
- **正規表現**: 入力は正規表現に一致する必要があります。
- **日本語**: 入力はひらがなまたはカタカナでなければなりません。
- **禁止コンテンツ**: 入力に特定の単語を含めたり、特定のパターンに一致させたりすることはできません。

### 分岐ロジック

**分岐**セクションを使用して会話の流れを制御できます。分岐は、ユーザーの入力に基づく条件と、条件が満たされた場合にジャンプする`nextStepId`を定義します。

- **条件タイプ**: `完全一致`, `部分一致`, `正規表現`。
- **照合する値**: ユーザーの入力に対してチェックする文字列またはパターン。
- **次のステップID**: 条件が真の場合のターゲットステップID。

分岐は順に評価されます。どの分岐条件も満たされない場合、ステップのデフォルトの`次のステップID`が使用されます。

### 特別なステップ

特別なステップは、インタラクションにおける一般的なシナリオのための定義済みの動作を持っています。

| 特別なステップ | 説明 |
| :--- | :--- |
| **確認** | ユーザーの入力を要約し、確認を求めるステップ。 |
| **編集ピッカー** | ユーザーが戻って編集したい以前のステップを選択するためのボタンを動的に生成するステップ。 |
| **完了** | インタラクションの最終ステップ。このステップの後、インタラクションは完了としてマークされます。 |
| **キャンセル確認** | ユーザーにインタラクションをキャンセルするかどうかを確認するステップ。 |
| **キャンセル済み** | ユーザーがキャンセルを確認した後に実行されるステップ。 |
| **タイムアウトリマインド** | タイムアウトリマインダーがトリガーされたときに送信するメッセージ。 |
| **タイムアウト通知** | インタラクションが公式にタイムアウトしたときに送信するメッセージ。 |

### アクション

ステップのライフサイクルの2つの時点でアクションを実行できます：
- **入力前アクション**: ユーザーが入力を行う前に、ステップが開始されるときに実行されます。
- **入力後アクション**: ユーザーが入力を提供し、それが検証された後に実行されます。

これにより、インタラクションの一部としてデータを取得したり、ユーザープロファイルを更新したり、他のプロセスをトリガーしたりできます。

## インタラクションデータの使用

以前のステップで収集したデータをメッセージやアクションパラメータ内で参照できます。`{{session.step_id}}`の形式を使用します。ここで`step_id`は、データにアクセスしたいステップのIDです。

たとえば、ユーザーが名前を入力する`ask-name`というIDのステップがある場合、後続のステップで`{{session.ask-name}}`を使用して個人宛に呼びかけることができます：

```
{{session.ask-name}}さん、こんにちは！私たちのサービスへようこそ。
```
